<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>RhythmBall - ç‹¬ç«‹æš‚åœæ§åˆ¶</title>
  <style>
    body {
      margin: 0;
      background: white;
      font-family: sans-serif;
    }
    #timeline {
      display: block;
      margin: 0 auto;
      background: #f0f0f0;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #e0e0e0;
    }
    #info {
      text-align: center;
      font-size: 16px;
      margin-top: 10px;
    }
    #controls {
      text-align: center;
      margin: 12px 0;
    }
    #progress {
      display: block;
      margin: 0 auto 12px;
      width: 90%;
      max-width: 1200px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="restart">â® é‡æ–°æ’­æ”¾</button>
    <button id="start">â–¶ æ’­æ”¾</button>
    <button id="pause">â¸ æš‚åœ</button>
    <button id="refresh">ğŸ”„ åˆ·æ–°</button>
    <button id="export">ğŸ“¦ å¯¼å‡ºå¸§</button>
  </div>

  <div id="info">ğŸ•’ 00:00.000ã€€ğŸµ Note #0</div>
  <input id="progress" type="range" disabled />
  <!-- <svg id="timeline" width="1000" height="80"></svg> -->
  <div id="controls">
    æ˜¾ç¤ºå®Œæ•´è·¯å¾„: <input type="checkbox" id="zoomSlider" checked="checked">
  </div>
  <canvas id="canvas" width="1000" height="700"></canvas>

  <script src="./lib/Tone-14.8.39.min.js"></script>
  <script type="module">
    import { MidiFileHandler } from './scripts/MidiFileHandler.js';
    import { Rhythm } from './scripts/Rhythm.js';
    import { CanvasResizer } from './scripts/CanvasResizer.js';
    import { TextureManager } from './scripts/TextureManager.js';
    import { fighterSkin } from './scripts/Characters/skins/fighter_skin.js';
    import { loadCharacterSkin } from './scripts/Characters/loadCharacterSkin.js';
    import { RhythmRecorder } from './scripts/RhythmRecorder.js';

    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('start');
    const pauseBtn = document.getElementById('pause');
    const restartBtn = document.getElementById('restart');
    const refreshBtn = document.getElementById('refresh');
    const exportBtn = document.getElementById('export');
    const info = document.getElementById('info');
    const progress = document.getElementById('progress');
    const zoomToggle = document.getElementById('zoomSlider');

    const midiPath = './assets/timeback_2025-05-27_15-12-54.mid';
    const audioPath = './assets/timeback_2025-05-27_15-21-07_sine.wav'; // âœ… æ›¿æ¢ä¸ºåˆæˆéŸ³é¢‘è·¯å¾„

    const audio = new Audio(audioPath);
    audio.preload = 'auto';
    audio.crossOrigin = 'anonymous';

    const resizer = new CanvasResizer(canvas);
    resizer.enableAutoResize({
      mode: [16, 9],
      getContainerSize: () => ({
        width: window.innerWidth - 100,
        height: window.innerHeight - 160
      })
    });

    const midi = new MidiFileHandler(midiPath);
    await midi.load(8);
    const events = midi.getEvents(0, 10);

    // const skin = await loadCharacterSkin(fighterSkin);
    const simulator = new Rhythm(canvas, events, {
      speed: 0.5,
      theme: 'default',
      characterSize: 40,
      debug: false,
      // characterSkin: skin,
      ballStyle(ctx, x, y, r) {
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fillStyle = '#000';
        ctx.shadowColor = '#000';
        ctx.shadowBlur = 12;
        ctx.fill();
        ctx.shadowColor = 'transparent';
        ctx.shadowBlur = 0;
      },
      drawTrail(ctx, p, radius) {
        ctx.beginPath();
        ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, 255, 255, ${p.life})`;
        ctx.fill();
      },
      wallColor: '#333',     // åé»‘å¢™ä½“
      glowColor: '#ffffff',     // æ’å‡»å‘å…‰è‰²
      background: '#ffff'     // æ·±ä¸­ç°èƒŒæ™¯
    });

    // TextureManager.loadPattern('./assets/textures/wall-ice.png').then((pattern) => {
    //   simulator.setWallPattern(pattern); // åŠ¨æ€åˆ‡æ¢
    // });
    TextureManager.loadPattern('./assets/textures/bg.png').then((pattern) => {
      simulator.setBgPattern(pattern); // åŠ¨æ€åˆ‡æ¢
    });

    progress.max = events.at(-1).time;
    progress.value = 0;

    zoomToggle.addEventListener('change', () => {
      simulator.camera.fitToPath(simulator.walls.getPath());
      simulator.camera.setMode(zoomToggle.checked ? 'fit' : 'pixel');
      simulator.render();
    });
    zoomToggle.checked = true;
    zoomToggle.dispatchEvent(new Event('change'));

    let rafId = null;
    let isPlaying = false;

    function formatTime(ms) {
      const s = Math.floor(ms / 1000);
      const msPart = Math.floor(ms % 1000).toString().padStart(3, '0');
      const min = Math.floor(s / 60).toString().padStart(2, '0');
      const sec = (s % 60).toString().padStart(2, '0');
      return `${min}:${sec}.${msPart}`;
    }

    function tick() {
      if (!isPlaying) return;

      const elapsed = audio.currentTime * 1000;
      progress.value = elapsed;

      const noteIndex = events.findIndex(e => e.time > elapsed);
      const currentIndex = noteIndex <= 0 ? 0 : noteIndex - 1;
      info.textContent = `ğŸ•’ ${formatTime(elapsed)}ã€€ğŸµ Note #${currentIndex}`;

      simulator.setCurrentTime(elapsed);
      rafId = requestAnimationFrame(tick);
    }

    // æ’­æ”¾æ§åˆ¶
    restartBtn.onclick = () => {
      audio.currentTime = 0;
      progress.value = 0;
      isPlaying = false;
      // ğŸš€ å¼€å§‹æ’­æ”¾éŸ³ä¹ + èŠ‚å¥åŠ¨ç”»
      audio.play();
      isPlaying = true;
      requestAnimationFrame(tick);
    };

    startBtn.onclick = () => {
      audio.play();
      isPlaying = true;
      requestAnimationFrame(tick);
    };

    pauseBtn.onclick = () => {
      audio.pause();
      isPlaying = false;
      cancelAnimationFrame(rafId);
    };

    refreshBtn.onclick = () => {
      simulator.refresh();
      simulator.render();
      if (isPlaying) {
        cancelAnimationFrame(rafId);
        requestAnimationFrame(tick);
      }
    };

    exportBtn.onclick = async () => {
      const duration = events.at(-1)?.time || 10000;

      const recorder = new RhythmRecorder(simulator, {
        duration,
        fps: 60
      });

      exportBtn.disabled = true;
      exportBtn.textContent = 'ğŸ“¦ æ­£åœ¨å¯¼å‡º...';

      await recorder.record();         // æ•æ‰æ¯å¸§
      await recorder.exportImages();   // ä¸‹è½½ zip åŒ…

      exportBtn.disabled = false;
      exportBtn.textContent = 'ğŸ“¦ å¯¼å‡ºå¸§å›¾åƒ';
    };

    // å¯é€‰è¿›åº¦æ‹–åŠ¨ï¼ˆè§£é”æ—¶å¯ç”¨ï¼‰
    progress.disabled = false;
    progress.addEventListener('input', () => {
      audio.currentTime = progress.value / 1000;
      simulator.setCurrentTime(progress.value);
      simulator.render();
    });

    </script>
</body>
</html>
