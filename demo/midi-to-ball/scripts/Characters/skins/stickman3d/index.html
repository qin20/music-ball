<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stickman Test</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    canvas { display: block; }
    #help {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      font-family: monospace;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="help">
    <b>Controls</b><br>
    A = Punch<br>
    S = Kick<br>
    D = Jump<br>
    F = Flash<br>
    G = Retreat<br>
    C = Combo<br>
    M = Slow Motion Combo
  </div>
  <script type="module">
    import * as THREE from 'https://esm.sh/three';
    import { createStickman, initStickmanDemo } from './stickman-model.js';
    import { MotionPlayer, ActionQueue, ActionLibrary, Pose } from './stickman-motion.js';

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const stickman = createStickman(scene);
    const player = new MotionPlayer(stickman);
    const queue = new ActionQueue(player);

    camera.position.set(0, 1.5, 3);
    function updateCamera() {
      const target = stickman.root.position;
      camera.lookAt(target.x, target.y + 0.5, target.z);
    }

    // 快速动作定义（Flash, Retreat, Combo, SlowMo）
    const flash = new MotionPlayer(stickman);
    const retreat = new MotionPlayer(stickman);

    const customMotions = {
      flash: {
        name: "flash",
        duration: 0.3,
        keyframes: [
          { time: 0, pose: { rightArm: { rotationZ: 0 } } },
          { time: 0.15, pose: { rightArm: { rotationZ: -0.5 } } },
          { time: 0.3, pose: { rightArm: { rotationZ: 0 } } }
        ].map(kf => ({ time: kf.time, pose: new Pose(kf.pose) }))
      },
      retreat: {
        name: "retreat",
        duration: 0.4,
        keyframes: [
          { time: 0, pose: { root: { positionY: 0 } } },
          { time: 0.2, pose: { root: { positionY: 0, z: -0.5 } } },
          { time: 0.4, pose: { root: { positionY: 0 } } }
        ].map(kf => ({ time: kf.time, pose: new Pose(kf.pose) }))
      }
    };

    async function combo() {
      await player.playMotion(ActionLibrary.jump);
      await player.playMotion(ActionLibrary.kickLeft);
      await player.playMotion(ActionLibrary.punchTurn);
    }

    async function slowMoCombo() {
      const originalTween = player.tweenToPose;
      player.tweenToPose = (pose, duration) => originalTween.call(player, pose, duration * 2);
      await combo();
      player.tweenToPose = originalTween;
    }

    window.addEventListener('keydown', e => {
      switch (e.key.toLowerCase()) {
        case 'a': queue.enqueue(ActionLibrary.punchTurn); break;
        case 's': queue.enqueue(ActionLibrary.kickLeft); break;
        case 'd': queue.enqueue(ActionLibrary.jump); break;
        case 'f': queue.enqueue(customMotions.flash); break;
        case 'g': queue.enqueue(customMotions.retreat); break;
        case 'c': combo(); break;
        case 'm': slowMoCombo(); break;
      }
    });

    function animate() {
      requestAnimationFrame(animate);
      updateCamera();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
